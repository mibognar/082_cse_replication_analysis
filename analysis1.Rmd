---
title: "analysis1"
author: "Miklos Bognar"
date: "2023-01-13"
output: html_document
---

# Load packages for this section
```{r message=F}
library(tidyverse)
library(papaja)
library(lme4)
library(lmerTest)
library(rstatix)
library(BayesFactor)
library(jsonlite)
library(ez)
```

# Loading source data
```{r}
hun_data = read_csv("data/hun_data.csv") %>% 
  mutate(site = "hungary")
it_data = read_csv("data/ita_data_fixed.csv") %>% 
  mutate(site = "italy")
sin_data = read_csv("data/sing_data_fixed.csv") %>% 
  mutate(site = "singapore")

source_data = rbind(hun_data,it_data, sin_data)
source_data = source_data %>% 
  group_by(participant_id) %>% 
  mutate(id = cur_group_id()) %>% 
  ungroup()

source_data %>% 
  group_by(id,site) %>%
  count() %>% 
  unique()
```


# Demographic analysis
---------------------------
```{r}

demographic = source_data %>% 
  filter(task == "survey") %>% 
  select(response,site) 

survey_data = purrr::map(demographic$response, jsonlite::fromJSON)
survey_data <- tibble(survey_data)  %>% 
  unnest_wider(survey_data)
survey_data = survey_data %>%
  mutate(sex = ifelse(nem %in% c("NÅ‘","Femmina","Female"), 1,0))

count(survey_data)
sum(survey_data$sex == 1)/count(survey_data)

demographic %>% 
  group_by(site) %>% 
  summarize(N = n())
```
## Anonimize dataframe
```{r}
raw_data = source_data %>% 
  filter(!(task %in% c("survey","consent")))

write_csv(raw_data,"data/zhang_replication_data.csv")
```

# Load anonimized data (START HERE)
```{r}
raw_data = read_csv("data/zhang_replication_data.csv")
```

# Prepare for sequential analysis
## Flag first trials in a block
```{r}
raw_data = raw_data %>% 
  mutate(first_trial = ifelse(lag(task,2) %in% c("pause_practice","pause"),1,0))
```

## Use only response data, exclude practice trials and first trials in every block
```{r}
raw_data = raw_data %>%
  filter(is.na(block)) %>%
  filter(task == "response") %>% 
  filter(first_trial == 0)
  

```

## Check all the conditions with mean RT
```{r}
raw_data %>% 
  group_by(congruency) %>% 
  summarize(N = n(),
            mean_rt = mean(as.numeric(rt), na.rm = T),
            sd_rt = sd(as.numeric(rt), na.rm = T),
            se_rt = sd_rt/sqrt(N)) %>% 
  ungroup()
```

## Create previous trial data
```{r}
raw_data = raw_data %>% 
  arrange(participant_id, as.numeric(trial_index)) %>% 
  mutate(previous_rt = lag(rt),
         previous_congruency = lag(congruency),
         previous_correct = lag(correct))
  
```

## Create rt and accuracy data
```{r}
raw_rt = raw_data %>% 
  filter(correct == T,
         previous_correct == T,
         previous_rt > 0)
```

```{r}
raw_accuracy = raw_data %>% 
  filter(previous_correct == T) %>% 
  mutate(acc = ifelse(correct==T, 1,0))
```

## Outlier detection
```{r}
rt_conditional_means = raw_rt %>% 
  group_by(id,congruency, previous_congruency) %>% 
  summarize(conditional_mean = mean(as.numeric(rt), na.rm = T),
            conditional_sd = sd(as.numeric(rt), na.rm=T))
  
raw_rt = raw_rt %>% 
  left_join(.,rt_conditional_means, by=c("id","congruency","previous_congruency"))


raw_rt = raw_rt %>% 
  mutate(rt = as.numeric(rt))

raw_rt = raw_rt %>% 
  mutate(rt_z = (rt-conditional_mean)/conditional_sd) %>% 
  mutate(drop_outlier = ifelse(abs(rt_z)>=3,1,0))


filtered_rt = raw_rt %>% 
  filter(drop_outlier == 0)
```
# ANALYSIS
## Create plot data
```{r}
cse_rt_data = filtered_rt %>% 
  group_by(congruency, previous_congruency) %>% 
  summarize(N = n(),
            mean_rt = mean(as.numeric(rt), na.rm = T),
            sd_rt = sd(rt, na.rm = T),
            se_rt = sd_rt/sqrt(N))
```
## Plot current + previous conditions RT
```{r}
cse_rt_plot = cse_rt_data %>% 
  ggplot()+
  aes(x=factor(previous_congruency, level=c("no_conflict","low_conflict", "high_conflict")), y=mean_rt, color=congruency, group=congruency)+
  geom_point(size=2)+
  geom_path(size=1)+
  geom_errorbar(size=1,aes(ymin=mean_rt-se_rt,
                    ymax=mean_rt+se_rt,
                    width=.2))+
  papaja::theme_apa()+
  labs(x="Previous Congruency",
       y= "Reaction time",
       color="Current Congruency",
       title="CSE plot")



cse_rt_plot
ggsave("cse_plot.png",plot=cse_rt_plot, width = 1600, height = 900, units = "px", dpi = 200)
```

## Frequentist Anova full factorial
### Create data by participant and by conditions
```{r}
subject_condition_data = filtered_rt %>% 
  group_by(id, congruency,previous_congruency) %>% 
  summarize(mean_rt = mean(rt, na.rm = T)) %>% 
  ungroup()
```
### Create repeated measures formula and conduct anova
```{r}
freq_aov = anova_test(data = subject_condition_data, formula = mean_rt ~ congruency * previous_congruency + Error(id/(congruency * previous_congruency)))
freq_aov

anova(freq_aov)
```

### Same formula, different package
```{r}
ezANOVA(data=subject_condition_data, dv=mean_rt, wid=id, within = .(congruency,previous_congruency))
```
2x3 ANOVA
```{r}
reduced_anova_data = subject_condition_data %>% 
  filter(previous_congruency %in% c("low_conflict","high_conflict"))

ezANOVA(data=reduced_anova_data, dv=mean_rt, wid=id, within = .(congruency,previous_congruency))
```



```{r}
library(bayestestR)
interaction_model = lmer(rt ~ congruency * previous_congruency + (1|id), data=filtered_rt)
summary(interaction_model)
anova(interaction_model)

no_interaction_model = lmer(rt ~ congruency + previous_congruency + (1|id), data=filtered_rt)

anova(no_interaction_model)

anova(no_interaction_model, interaction_model)


comparision = bayesfactor_models(no_interaction_model, interaction_model)
comparision
```
Dienes-way bayes factor
```{r}
filtered_rt = filtered_rt %>% 
  mutate(prev_num = case_when(previous_congruency == "no_conflict" ~ 0,
                              previous_congruency == "low_conflict" ~ 1,
                              TRUE ~ 2),
         current_num = case_when(congruency == "no_conflict" ~ 0,
                              congruency == "low_conflict" ~ 1,
                              TRUE ~ 2))
```

```{r}
numeric_interaction_model = lmer(rt ~ prev_num * current_num + (1|id), data=filtered_rt)
summary(numeric_interaction_model)

numeric_model = summary(numeric_interaction_model)
numeric_model
```
```{r}
source("dienes_bayes.R")
Bf(sd = numeric_model$coefficients[8], obtained = numeric_model$coefficients[4]*-1, likelihood = "normal",
modeloftheory= "normal", modeoftheory = 0,
scaleoftheory = numeric_model$coefficients[1], tail = 1, method = "new")
```

robustness region
```{r}
h1_range = seq(from=0.1,to=2000,by=0.1)
range_test <- Bf_range(numeric_model$coefficients[8], numeric_model$coefficients[4]*-1,
likelihood = "normal",
modeloftheory = "normal",
modeoftheory=0,
sdtheoryrange= h1_range,
tail=1, method = "new")
# find values for which BF > 3
ev_for_h1 <- subset(data.frame(range_test), BF > 3)
low_threshold <- min(ev_for_h1$sdtheory)
high_threshold <- max(ev_for_h1$sdtheory)
```


```{r}
print(low_threshold)
```

```{r}
print(high_threshold)
```

## Crucial 2x3 mixed effect model

```{r}
crucial_model_data = filtered_rt %>% 
  filter(prev_num>0) %>% 
  mutate(prev_num = case_when(prev_num == 1 ~ 0,
                   T ~ 1))

crucial_model_summary = crucial_model_data %>% 
  group_by(prev_num, current_num) %>% 
  summarize(meanrt = mean(rt, na.rm=T))

crucial_numeric_interaction_model = lmer(rt ~ prev_num * current_num + (1|id), data=crucial_model_data)
summary(crucial_numeric_interaction_model)

crucial_numeric_model = summary(crucial_numeric_interaction_model)
crucial_numeric_model
```
### BF for crucial model
```{r}
Bf(sd = crucial_numeric_model$coefficients[8], obtained = crucial_numeric_model$coefficients[4]*-1, likelihood = "normal",
modeloftheory= "normal", modeoftheory = 0,
scaleoftheory = crucial_numeric_model$coefficients[1], tail = 1, method = "new")
```
robustness region
```{r}
range_test <- Bf_range(crucial_numeric_model$coefficients[8], crucial_numeric_model$coefficients[4]*-1,
likelihood = "normal",
modeloftheory = "normal",
modeoftheory=0,
sdtheoryrange= h1_range,
tail=1, method = "new")
# find values for which BF > 3
crucial_ev_for_h1 <- subset(data.frame(range_test), BF > 3)
crucial_low_threshold <- min(crucial_ev_for_h1$sdtheory)
crucial_high_threshold <- max(crucial_ev_for_h1$sdtheory)
```

# Increasing the level of conflict leads to conflict adaptation
```{r}
conflict_level_data = filtered_rt %>% 
  mutate(is_congruent = case_when(congruency == "no_conflict" ~ 1,
                                  T ~ 0),
         is_prev_congruent = case_when(previous_congruency == "no_conflict"~ 1,
                                       T~ 0))

increased_conflict_data = conflict_level_data %>% 
  filter(previous_congruency %in% c("low_conflict","high_conflict"))

increased_conflict_data_means = increased_conflict_data %>% 
   group_by(is_congruent, previous_congruency) %>% 
  summarize(N = n(),
            mean_rt = mean(as.numeric(rt), na.rm = T),
            sd_rt = sd(rt, na.rm = T),
            se_rt = sd_rt/sqrt(N))

increased_conflict_data_means_plot = increased_conflict_data_means %>% 
  ggplot()+
  aes(x=factor(previous_congruency, levels = c("low_conflict","high_conflict")), y=mean_rt, color=as.factor(is_congruent), group=as.factor(is_congruent))+
  geom_point(size=2)+
  geom_path(size=1)+
  geom_errorbar(size=1,aes(ymin=mean_rt-se_rt,
                    ymax=mean_rt+se_rt,
                    width=.2))+
  papaja::theme_apa()+
  labs(x="Previous Congruency",
       y= "Reaction time",
       color="Current Congruency",
       title="Pilot CSE plot")

increased_conflict_data_means_plot
```
```{r}
conflict_level_model = lmer(rt ~ is_congruent*previous_congruency + (1|id), data = increased_conflict_data)
summary(conflict_level_model)
anova(conflict_level_model)


```

# General CSE plot
```{r}
cse_rt_data_no_levels = conflict_level_data %>% 
  group_by(is_congruent, is_prev_congruent) %>% 
  summarize(N = n(),
            mean_rt = mean(as.numeric(rt), na.rm = T),
            sd_rt = sd(rt, na.rm = T),
            se_rt = sd_rt/sqrt(N))

cse_rt_data_no_levels_plot = cse_rt_data_no_levels %>% 
  ggplot()+
  aes(x=as.factor(is_prev_congruent), y=mean_rt, color=as.factor(is_congruent), group=as.factor(is_congruent))+
  geom_point(size=2)+
  geom_path(size=1)+
  geom_errorbar(size=1,aes(ymin=mean_rt-se_rt,
                    ymax=mean_rt+se_rt,
                    width=.2))+
  papaja::theme_apa()+
  labs(x="Previous Congruency",
       y= "Reaction time",
       color="Current Congruency",
       title="Pilot CSE plot")

cse_rt_data_no_levels_plot
```


# Accuracy analysis with plot
```{r}
cse_acc_data = raw_accuracy %>% 
  group_by(congruency, previous_congruency) %>% 
  summarize(N = n(),
            mean_acc = mean(acc, na.rm = T),
            error_rate = 1-mean_acc,
            sd_acc = sd(acc, na.rm = T),
            se_acc = sd_acc/sqrt(N))
```
```{r}
cse_acc_plot = cse_acc_data %>% 
  ggplot()+
  aes(x=factor(previous_congruency, level=c("no_conflict","low_conflict","high_conflict")), y=error_rate, color=congruency, group=congruency)+
  geom_point(size=2)+
  geom_path(size=1)+
  geom_errorbar(size=1,aes(ymin=error_rate-se_acc,
                    ymax=error_rate+se_acc,
                    width=.2))+
  papaja::theme_apa()+
  labs(x="Previous Congruency",
       y= "Mean error_rate",
       color="Current Congruency",
       title="Pilot CSE plot - Accuracy")



cse_acc_plot
```
```{r}
mymodel_acc = lmer(acc ~ congruency * previous_congruency + (1|id), data=raw_accuracy)

summary(mymodel_acc)
anova(mymodel_acc)

reduced_model = lmer(acc ~ congruency + previous_congruency + (1|id), data = raw_accuracy)
anova(reduced_model)

anova(reduced_model,mymodel_acc)

bayesfactor_models(reduced_model, mymodel_acc)
```
```{r}
pairwise_t_test(filter(raw_accuracy, congruency=="low_conflict"), acc ~ previous_congruency, p.adjust.method = "bonferroni")
pairwise_t_test(filter(raw_accuracy, congruency=="no_conflict"), acc ~ previous_congruency, p.adjust.method = "bonferroni")
```